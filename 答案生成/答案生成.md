# RAG检索查询系统说明文档

## 项目概述

这是一个基于RAG（Retrieval-Augmented Generation）技术的半导体显示技术问答系统，主要用于处理和回答半导体显示领域的专业问题。系统通过向量检索相关文档切片，结合大语言模型生成准确的答案。

## 系统架构

### 核心组件

1. **向量检索模块** (`request_search.py`)
2. **数据处理模块** (`xlsx_to_vector_chunk_only.py`)  
3. **模型推理模块** (`test_0427C_wo_depre_greedysearch.py`)

## 文件说明

### 1. request_search.py - 检索服务模块

**主要功能：**
- 向量检索服务接口
- 百度翻译API集成
- 多语言检索支持

**核心函数：**

```python
def search_answer_online(query: str, port: int, top_doc_num: int = 5)
```
- **功能**：通过向量检索召回与查询相关的文本切片
- **参数**：
  - `query`: 查询问题
  - `port`: 检索服务端口
  - `top_doc_num`: 返回文档数量（默认5个）
- **返回**：相关文档列表，包含答案ID、标题、文本、索引和相似度分数

```python
def baidu_translate(text: str, from_lang: str, to_lang: str)
```
- **功能**：使用百度翻译API进行中英文互译
- **用途**：支持中英文双语检索，提高召回准确性

### 2. xlsx_to_vector_chunk_only.py - 数据处理主程序

**主要功能：**
- Excel数据读取和处理
- 多线程检索（中文+英文）
- 结果去重和合并
- 答案生成和保存

**工作流程：**

1. **数据读取**
   ```python
   file_path = '/mnt/hdd1/haoyangliu/playground/data/100道全领域评测题.xlsx'
   df = pd.read_excel(file_path)
   query_array = df['Query'].to_numpy()
   ```

2. **双语检索**
   ```python
   def get_en_anser(item):  # 英文检索
   def get_zh_anser(item):  # 中文检索
   ```

3. **结果处理**
   - 去重处理：基于文本内容去除重复切片
   - 数据合并：整合中英文检索结果
   - 格式化：组织成标准格式用于模型输入

4. **答案生成**
   ```python
   def quest_step(query: str, passages: list)
   ```
   - 使用DeepSeek模型生成最终答案
   - 结合检索到的知识切片
   - 格式化输出专业回答

### 3. test_0427C_wo_depre_greedysearch.py - 模型推理模块

**主要功能：**
- 大语言模型加载和推理
- RAG提示词模板
- 批量处理和结果保存

**核心组件：**

1. **RAG提示词模板**
   ```python
   def rag_prompt(q, contexts)
   ```
   - 专为半导体显示领域设计的提示词
   - 结合上下文信息和问题进行回答
   - 要求分点回答，逻辑清晰

2. **模型推理**
   ```python
   def get_model_response(input_text, model, tokenizer)
   ```
   - 支持Qwen系列模型
   - 使用chat模板格式
   - 贪婪搜索策略生成答案

3. **批量处理**
   ```python
   def test(model_path, query_path, save_file_path)
   ```
   - 批量读取Excel中的问题
   - 逐个处理并保存结果
   - 支持断点续传

## 系统配置

### 环境要求
- Python 3.8+
- PyTorch
- Transformers
- pandas, openpyxl
- requests

### 服务配置
- **向量检索服务**：`http://10.70.223.31:1508`
- **ChatGLM服务**：`http://10.70.223.193:8010`
- **DeepSeek API**：`https://api.deepseek.com`

### 模型路径
```python
model_path = "/mnt/data/MLLM/liuchi/trained_models/Qwen3-32B-dpo-5w_retrain"
```

## 使用方法

### 1. 准备数据
将问题整理到Excel文件中，确保包含`Query`列：
```
| Query                           |
|--------------------------------|
| TFT显示技术的工作原理是什么？    |
| OLED与LCD的主要区别有哪些？     |
```

### 2. 运行检索和切片生成
```bash
python xlsx_to_vector_chunk_only.py
```
- 自动进行中英文双语检索
- 生成包含问题、切片和答案的Excel文件

### 3. 运行模型推理
```bash
python test_0427C_wo_depre_greedysearch.py
```
- 基于检索到的切片生成最终答案
- 保存完整的问答结果

## 输出格式

### 检索结果
每个问题对应的检索结果包含：
- **Question**: 原始问题
- **Chunk**: 检索到的相关文档切片
- **Answer**: 生成的答案

### 切片格式
```
chunk:0,source:文档名称
具体的文档内容切片...

chunk:1,source:文档名称  
具体的文档内容切片...
```

## 特色功能

### 1. 双语检索
- 同时进行中文和英文检索
- 提高专业术语的召回准确性
- 自动去重避免内容重复

### 2. 专业领域适配
- 专门针对半导体显示技术领域
- 定制化的提示词模板
- 分点式回答格式

### 3. 批量处理
- 支持Excel批量导入
- 自动保存中间结果
- 支持断点续传处理

### 4. 多模型支持
- 支持Qwen系列模型
- 集成ChatGLM和DeepSeek
- 灵活的模型切换

## 注意事项

1. **网络依赖**：需要稳定的网络连接访问翻译和检索服务
2. **GPU需求**：推理过程需要CUDA环境
3. **存储空间**：大模型需要足够的磁盘空间
4. **API配额**：注意百度翻译和DeepSeek的API使用限制

## 错误处理

系统包含完善的错误处理机制：
- 网络请求超时重试
- 非法字符清理
- 空值和异常数据处理
- 自动跳过处理失败的条目

## 扩展建议

1. **缓存机制**：添加检索结果缓存减少重复请求
2. **并发优化**：增加并发处理提高效率
3. **评估指标**：添加答案质量评估模块
4. **界面优化**：开发Web界面提供更好的用户体验